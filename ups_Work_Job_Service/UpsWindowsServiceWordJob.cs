using System; using System.ServiceProcess; using System.Timers; using ups_Business; using ups_DAO; namespace ups_Work_Job_Service { public partial class UpsWindowsServiceWordJob : ServiceBase { private Timer _timer; private readonly JobsService _jobs=new JobsService(); private readonly SchedulerService _scheduler=new SchedulerService(); private readonly JobSchedulesDao _sDao=new JobSchedulesDao(); public UpsWindowsServiceWordJob(){ InitializeComponent(); ServiceName="ups_Work_Job_Service"; } protected override void OnStart(string[] args){ _timer = new Timer(60000); _timer.Elapsed += (s,e)=> Tick(); _timer.AutoReset = true; _timer.Start(); } private void Tick(){ var now = DateTime.UtcNow; _scheduler.EvaluateAndUpdateNextRuns(now); foreach(var sch in _sDao.GetDue(now)){ try{ _jobs.RunJob(sch.JobId); var next=_scheduler.ComputeNextRunUtc(sch,now); _sDao.UpdateNextRunAndEval(sch.ScheduleId,next,now);} catch{} } } protected override void OnStop(){ _timer?.Stop(); _timer?.Dispose(); } } }